{"version":3,"sources":["../../../../server/api/user/user.controller.js"],"names":["User","require","passport","config","jwt","validationError","res","statusCode","err","status","json","handleError","send","exports","index","req","find","exec","then","users","catch","create","next","newUser","body","provider","role","save","user","token","sign","_id","secrets","session","expiresIn","show","userId","params","id","findById","end","profile","destroy","findByIdAndRemove","changePassword","oldPass","String","oldPassword","newPass","newPassword","authenticate","password","me","findOne","authCallback","redirect"],"mappings":"AAAA;;AAEA,IAAIA,OAAOC,QAAQ,cAAR,CAAX;AACA,IAAIC,WAAWD,QAAQ,UAAR,CAAf;AACA,IAAIE,SAASF,QAAQ,0BAAR,CAAb;AACA,IAAIG,MAAMH,QAAQ,cAAR,CAAV;;AAEA,SAASI,eAAT,CAAyBC,GAAzB,EAA8BC,UAA9B,EAA0C;AACxCA,eAAaA,cAAc,GAA3B;AACA,SAAO,UAASC,GAAT,EAAc;AACnBF,QAAIG,MAAJ,CAAWF,UAAX,EAAuBG,IAAvB,CAA4BF,GAA5B;AACD,GAFD;AAGD;;AAED,SAASG,WAAT,CAAqBL,GAArB,EAA0BC,UAA1B,EAAsC;AACpCA,eAAaA,cAAc,GAA3B;AACA,SAAO,UAASC,GAAT,EAAc;AACnBF,QAAIG,MAAJ,CAAWF,UAAX,EAAuBK,IAAvB,CAA4BJ,GAA5B;AACD,GAFD;AAGD;;AAED;;;;AAIAK,QAAQC,KAAR,GAAgB,UAASC,GAAT,EAAcT,GAAd,EAAmB;AACjC,SAAON,KAAKgB,IAAL,CAAU,EAAV,EAAc,iBAAd,EAAiCC,IAAjC,GACJC,IADI,CACC,iBAAS;AACbZ,QAAIG,MAAJ,CAAW,GAAX,EAAgBC,IAAhB,CAAqBS,KAArB;AACD,GAHI,EAIJC,KAJI,CAIET,YAAYL,GAAZ,CAJF,CAAP;AAKD,CAND;;AAQA;;;AAGAO,QAAQQ,MAAR,GAAiB,UAASN,GAAT,EAAcT,GAAd,EAAmBgB,IAAnB,EAAyB;AACxC,MAAIC,UAAU,IAAIvB,IAAJ,CAASe,IAAIS,IAAb,CAAd;AACAD,UAAQE,QAAR,GAAmB,OAAnB;AACAF,UAAQG,IAAR,GAAe,MAAf;AACAH,UAAQI,IAAR,GACGT,IADH,CACQ,UAASU,IAAT,EAAe;AACnB,QAAIC,QAAQzB,IAAI0B,IAAJ,CAAS,EAAEC,KAAKH,KAAKG,GAAZ,EAAT,EAA4B5B,OAAO6B,OAAP,CAAeC,OAA3C,EAAoD;AAC9DC,iBAAW,KAAK,EAAL,GAAU;AADyC,KAApD,CAAZ;AAGA5B,QAAII,IAAJ,CAAS,EAAEmB,YAAF,EAAT;AACD,GANH,EAOGT,KAPH,CAOSf,gBAAgBC,GAAhB,CAPT;AAQD,CAZD;;AAcA;;;AAGAO,QAAQsB,IAAR,GAAe,UAASpB,GAAT,EAAcT,GAAd,EAAmBgB,IAAnB,EAAyB;AACtC,MAAIc,SAASrB,IAAIsB,MAAJ,CAAWC,EAAxB;;AAEA,SAAOtC,KAAKuC,QAAL,CAAcH,MAAd,EAAsBnB,IAAtB,GACJC,IADI,CACC,gBAAQ;AACZ,QAAI,CAACU,IAAL,EAAW;AACT,aAAOtB,IAAIG,MAAJ,CAAW,GAAX,EAAgB+B,GAAhB,EAAP;AACD;AACDlC,QAAII,IAAJ,CAASkB,KAAKa,OAAd;AACD,GANI,EAOJrB,KAPI,CAOE;AAAA,WAAOE,KAAKd,GAAL,CAAP;AAAA,GAPF,CAAP;AAQD,CAXD;;AAaA;;;;AAIAK,QAAQ6B,OAAR,GAAkB,UAAS3B,GAAT,EAAcT,GAAd,EAAmB;AACnC,SAAON,KAAK2C,iBAAL,CAAuB5B,IAAIsB,MAAJ,CAAWC,EAAlC,EAAsCrB,IAAtC,GACJC,IADI,CACC,YAAW;AACfZ,QAAIG,MAAJ,CAAW,GAAX,EAAgB+B,GAAhB;AACD,GAHI,EAIJpB,KAJI,CAIET,YAAYL,GAAZ,CAJF,CAAP;AAKD,CAND;;AAQA;;;AAGAO,QAAQ+B,cAAR,GAAyB,UAAS7B,GAAT,EAAcT,GAAd,EAAmBgB,IAAnB,EAAyB;AAChD,MAAIc,SAASrB,IAAIa,IAAJ,CAASG,GAAtB;AACA,MAAIc,UAAUC,OAAO/B,IAAIS,IAAJ,CAASuB,WAAhB,CAAd;AACA,MAAIC,UAAUF,OAAO/B,IAAIS,IAAJ,CAASyB,WAAhB,CAAd;;AAEA,SAAOjD,KAAKuC,QAAL,CAAcH,MAAd,EAAsBnB,IAAtB,GACJC,IADI,CACC,gBAAQ;AACZ,QAAIU,KAAKsB,YAAL,CAAkBL,OAAlB,CAAJ,EAAgC;AAC9BjB,WAAKuB,QAAL,GAAgBH,OAAhB;AACA,aAAOpB,KAAKD,IAAL,GACJT,IADI,CACC,YAAM;AACVZ,YAAIG,MAAJ,CAAW,GAAX,EAAgB+B,GAAhB;AACD,OAHI,EAIJpB,KAJI,CAIEf,gBAAgBC,GAAhB,CAJF,CAAP;AAKD,KAPD,MAOO;AACL,aAAOA,IAAIG,MAAJ,CAAW,GAAX,EAAgB+B,GAAhB,EAAP;AACD;AACF,GAZI,CAAP;AAaD,CAlBD;;AAoBA;;;AAGA3B,QAAQuC,EAAR,GAAa,UAASrC,GAAT,EAAcT,GAAd,EAAmBgB,IAAnB,EAAyB;AACpC,MAAIc,SAASrB,IAAIa,IAAJ,CAASG,GAAtB;;AAEA,SAAO/B,KAAKqD,OAAL,CAAa,EAAEtB,KAAKK,MAAP,EAAb,EAA8B,iBAA9B,EAAiDnB,IAAjD,GACJC,IADI,CACC,gBAAQ;AAAE;AACd,QAAI,CAACU,IAAL,EAAW;AACT,aAAOtB,IAAIG,MAAJ,CAAW,GAAX,EAAgB+B,GAAhB,EAAP;AACD;AACDlC,QAAII,IAAJ,CAASkB,IAAT;AACD,GANI,EAOJR,KAPI,CAOE;AAAA,WAAOE,KAAKd,GAAL,CAAP;AAAA,GAPF,CAAP;AAQD,CAXD;;AAaA;;;AAGAK,QAAQyC,YAAR,GAAuB,UAASvC,GAAT,EAAcT,GAAd,EAAmBgB,IAAnB,EAAyB;AAC9ChB,MAAIiD,QAAJ,CAAa,GAAb;AACD,CAFD","file":"user.controller.js","sourcesContent":["'use strict';\n\nvar User = require('./user.model');\nvar passport = require('passport');\nvar config = require('../../config/environment');\nvar jwt = require('jsonwebtoken');\n\nfunction validationError(res, statusCode) {\n  statusCode = statusCode || 422;\n  return function(err) {\n    res.status(statusCode).json(err);\n  }\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function(err) {\n    res.status(statusCode).send(err);\n  };\n}\n\n/**\n * Get list of users\n * restriction: 'admin'\n */\nexports.index = function(req, res) {\n  return User.find({}, '-salt -password').exec()\n    .then(users => {\n      res.status(200).json(users);\n    })\n    .catch(handleError(res));\n}\n\n/**\n * Creates a new user\n */\nexports.create = function(req, res, next) {\n  var newUser = new User(req.body);\n  newUser.provider = 'local';\n  newUser.role = 'user';\n  newUser.save()\n    .then(function(user) {\n      var token = jwt.sign({ _id: user._id }, config.secrets.session, {\n        expiresIn: 60 * 60 * 5\n      });\n      res.json({ token });\n    })\n    .catch(validationError(res));\n}\n\n/**\n * Get a single user\n */\nexports.show = function(req, res, next) {\n  var userId = req.params.id;\n\n  return User.findById(userId).exec()\n    .then(user => {\n      if (!user) {\n        return res.status(404).end();\n      }\n      res.json(user.profile);\n    })\n    .catch(err => next(err));\n}\n\n/**\n * Deletes a user\n * restriction: 'admin'\n */\nexports.destroy = function(req, res) {\n  return User.findByIdAndRemove(req.params.id).exec()\n    .then(function() {\n      res.status(204).end();\n    })\n    .catch(handleError(res));\n}\n\n/**\n * Change a users password\n */\nexports.changePassword = function(req, res, next) {\n  var userId = req.user._id;\n  var oldPass = String(req.body.oldPassword);\n  var newPass = String(req.body.newPassword);\n\n  return User.findById(userId).exec()\n    .then(user => {\n      if (user.authenticate(oldPass)) {\n        user.password = newPass;\n        return user.save()\n          .then(() => {\n            res.status(204).end();\n          })\n          .catch(validationError(res));\n      } else {\n        return res.status(403).end();\n      }\n    });\n}\n\n/**\n * Get my info\n */\nexports.me = function(req, res, next) {\n  var userId = req.user._id;\n\n  return User.findOne({ _id: userId }, '-salt -password').exec()\n    .then(user => { // don't ever give out the password or salt\n      if (!user) {\n        return res.status(401).end();\n      }\n      res.json(user);\n    })\n    .catch(err => next(err));\n}\n\n/**\n * Authentication callback\n */\nexports.authCallback = function(req, res, next) {\n  res.redirect('/');\n}\n"]}